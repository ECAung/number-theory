\chapter{Ideal factorization}\llabel{factorization}

\section{Discrete Valuation Rings}
\index{discrete valuations}
\begin{df}
Let $K$ be a field. A \textbf{discrete valuation} on $K$ is a surjective function $v:K^{\times}\to\Z$ such that for every $x,y\in K^{\times}$,
\begin{enumerate}
\item $\pi$ is a group homeomorphism: 
$v(xy)=v(x)v(y)$.
\item 
$v(x+y)\geq \min(v(x),v(y))$.
\end{enumerate}
We set $v(0)=\infty$.

A \textbf{discrete valuation ring} (over $\Z$) is a local integral domain $R$ (not a field), whose fraction field has a discrete valuation $v$.

An element $t$ with $v(t)=1$ is a \textbf{uniformizing parameter}.
\end{df}
\begin{pr}
Suppose $R$ is a DVR with fraction field $K$. Let $v$ be the valuation on $K$.
\begin{enumerate}
\item The units are exactly the elements with 0 valuation:
\[R^{\times}=v^{-1}(0).\]
\item %$R$ is local but not a field.
Its maximal idea is the set of elements with positive valuation.
\[
\mm=\set{x}{v(x)>0}.
\]
\item 
$R$ is a PID with ideals $\mm^n=\set{x}{v(x)\geq n}=(t^n)$ for $n\in \N$.
\item
$R$ is a UFD; any element can be written uniquely in the form $ut^n$ where $u$ is a unit.
\end{enumerate}
\end{pr}
\begin{lem}
Let $A$ be a local domain with maximal ideal $\mm$ principal and nonzero. If $\bigcap_{n\geq 0}\mm^n=0$ then $A$ is a DVR.
\end{lem}
\begin{thm}
Let $(A,\mm)$ be a Noetherian local domain. The following conditions are equivalent.
\begin{enumerate}
\item $A$ is a DVR.
\item $A$ is a normal domain of dimension 1. (Dimension 1 means that the longest chain of prime ideals is 2: $\mfp_0\subeq \mfp_1$.) (Since $A$ is local this means it has only two prime ideals.)
\item $A$ is a normal domain of depth 1. (There is a nonzero $x\in A$ with $\mm\in \Ass(A/\an{x})$.)
\item $A$ is a regular local ring of dimension 1. (Regular means its maximal ideal is generated by a number of elements equal to its dimension. So here it means $\mm$ is principal.)
\item $\mm$ is principal and nonzero.
\end{enumerate}
\end{thm}
\begin{proof}
Note (5)$\implies$(1) uses Krull Intersection Theorem: For $R$ a Noetherian ring, $\ma$ an ideal, and $M$ a finitely generated module (esp. when $M=R$), then there exists $x\in \ma$ such that 
\[
(1+x)\bigcap_{n=0}^{\infty} \ma^nM=0.
\] 
\end{proof}
\section{Dedekind Domains}
\index{Dedekind domain}
\begin{df}
A \textbf{Dedekind domain} is a normal Noetherian integral domain $A$ such that every nonzero prime ideal is maximal.
\end{df}
\begin{pr}
A local integral domain is Dedekind iff it is a DVR.
\end{pr}
\begin{pr}
For every nonzero prime ideal $\mfp$ in a Dedekind domain $A$, the localization $A_{\mfp}$ is a DVR. ({\it Locally, Dedekind domains are DVR's}.)
\end{pr}
(The converse, i.e. if $A_{\mfp}$ is a DVR for every $\mfp$, then $A$ is Dedekind, holds using Serre's criterion.)

\begin{thm}[Unique factorization of prime ideals]\llabel{uf-dedekind}
Let $A$ be a Dedekind domain. Every proper nonzero ideal of $A$ can be written uniquely as a product of prime ideals.
\end{thm}
\begin{proof}
Let $\ma$ be a proper nonzero ideal of $A$.
\begin{enumerate}
\item
If $A$ is Noetherian, then every ideal $\ma\subeq A$ contains a product $\mb=\prod \mfp_k^{r_k}$ of nonzero prime ideals: Otherwise, choose a maximal counterexample $\ma$ (possible since $A$ is Noetherian). Since $\ma$ is not prime, there exist $x,y\nin \ma$ such that $xy\in \ma$. By the maximality assumption both $\ma+(x)$ and $\ma+(y)$ contain a product of prime ideals, and so does $\ma\supeq (\ma+(x))(\ma+(y))$.
\item
By the Chinese Remainder Theorem
\[
A/\mb \cong \prod_{k} A/\mfp_k^{r_k}
\]
via the natural map.
\item If $\mfp$ is a maximal ideal in a ring $A$, and $\mq=\mfp A_{\mfp}$, then the natural map $A/\mfp^m\to (A/\mfp^m)_{\mfp}= A_{\mfp}/\mq^m$  is an isomorphism. (Indeed, it is injective because $\mfp$ is prime and surjective because any $s\in A-\mfp$ is invertible modulo $\mfp^m$, on account of $(s)+\mfp^m=A$.) Thus
\[
\prod_{k} A/\mfp_k^{r_k}\cong \prod_k A_{\mfp_k}/\mq_k^{r_k}.
\]
(This is where we use the fact that nonzero prime ideals are maximal.)
\item Combining the above, we get a one-to-one correspondence between ideals in $A$ containing $\mb$, and ideals in $\prod_k A_{\mfp_k}/\mq_k^{r_k}$. All ideals in the last ring are in the form $\prod_k \mq_k^{s_k}/\mq_k^{r_k}$, so $\ma$ is of the form $\prod_k \mq_k^{s_k}$. Moreover, different prime ideals containing $\mb$ correspond to different $\prod_k \mq_k^{s_k}/\mq_k^{r_k}$, which are different for different $s_k$, giving uniqueness.\qedhere
\end{enumerate}
\end{proof}
\begin{cor}\llabel{uf-dedekind-cor}
Let $A$ be a Dedekind domain.
\begin{enumerate}
\item
If $\ma=\prod_{\mfp} \mfp_k^{r_k}$ and 
$\mb=\prod_{\mfp} \mfp_k^{s_k}$ are ideals in $A$ and $\mfp$ is a nonzero prime ideal then
\begin{align*}
\ma\supeq \mb&\iff r_k\ge s_k\text{ for all }k\\
&\iff \ma A_{\mfp}\supeq \mb A_{\mfp} \text{ for all }\mfp.
\end{align*}
\item
If $\ma\supset \mb\neq 0$ are ideals in $A$ then $\ma=\mb+(a)$ for some $a\in A$. In particular, if $b\in \ma$ then there exists $a\in A$ such that $\ma=(a,b)$; i.e. each ideal is generated by at most two elements.
\item (Inverses)
Let $\ma\ne 0$ be an ideal of $A$. There exists a nonzero ideal $\ma^*$ such that $\ma\ma^*$ is principal.
\begin{enumerate}
\item
We can choose $\ma^*$ so $\ma\ma^*=(a)$ for given $a\in \ma$. 
\item
Alternatively we can choose $\ma^*$ to be relatively prime to a given ideal $\mc\ne 0$. 
\end{enumerate}
\end{enumerate}
\end{cor}
\begin{proof}
\begin{enumerate}
\item The forward direction was shown in the course of the theorem. The reverse directions are easy. 
\item Choose any $a\in \ma\bs\{0\}$. By unique factorization, we can write
\begin{align*}
(a)&=\mfp_1^{u_1}\cdots \mfp_{r}^{u_r}\\
\ma&=\mfp_1^{v_1}\cdots \mfp_{r}^{v_r}
\end{align*}
for primes $\mfp_1,\ldots, \mfp_r$ and $u_j\ge v_j\ge 0$. Now choose $b_j\in \mfp_j^{v_j}\bs\mfp_j^{v_{j}+1}$. By the Chinese remainder theorem we can choose $b$ such that $b\equiv b_j\pmod{\mfp_j^{v_j+1}}$ for all $j$. 
Since $\ord_{\mfp_j}(b_j)=v_j$, by item 1, the highest power of $\mfp_j$ dividing $(b)$ is $v_j$. The highest power of $\mfp_j$ dividing $(a)$ is $u_j\ge v_j$, so the highest power of $\mfp_j$ dividing $(a,b)$ is $v_j$.
Now for a prime $\mq\nin\{\mfp_1,\ldots, \mfp_r\}$, we have $a\nin \mq$ (else $\mq$ would divide $\ma$), so $\mq$ does not divide $(a,b)$. We conclude
\[
(a,b)=\mfp_1^{v_1}\cdots \mfp_{r}^{v_r},
\]
as needed.
\item (a) follows from item 1; for (b), use item 2 and 3(a) to write $\ma=\ma \mc+(a)=\ma\mc + \ma\ma^*=\ma(\mc+\ma^*)$.
\end{enumerate}
\end{proof}
\begin{thm}\llabel{extension-dedekind}
Assume AKLB, and $K/L$ is finite separable. If $A$ is a Dedekind domain, then so is $B$. In particular, taking $A=\Z$ and $K=\Q$, every ring of integers in a finite separable extension of $\Q$ is Dedekind.
\fixme{[Separability is not needed. TODO: proof of general case, Janusz I.6.1]}
\end{thm}$\,$
\begin{proof}$\,$
\begin{enumerate}
\item $B$ is noetherian: By Proposition~\ref{fgoie}, $B$ is a finitely generated $A$-module, hence a Noetherian $A$-module, hence Noetherian as a ring.
\item $B$ is integrally closed by Proposition~\ref{integrality}(2).
\item Every nonzero prime ideal $\mq$ of $B$ is maximal: Take a nonzero $\be\in \mq$ and let its minimal polynomial be $x^n+a_{n-1}x^{n-1}+\cdots +a_n$. Then $a_n=-\be^n-\cdots -a_1\be\in \be B\cap A\subeq \mq\cap A$. This shows $\mq\cap A\ne 0$; since $A$ is Dedekind and $\mq\cap A$ is prime, $\mq\cap A$ is maximal and $A/\mq$ is a field. Since $B$ is integral over $A$, $B/\mq$ is integral over $A/\mq$.
\begin{lem}\llabel{int-dom-field}
An integral domain $B$ containing a field $k$ and algebraic over $k$ is a field.
\end{lem}
\begin{proof}
Let $\be\in B$ be nonzero. Then $k[\be]$ is a finite dimensional vector space and the multiplication-by-$\be$ map $m_{\be}:k[\be]\to k[\be]$ is injective, hence surjective. Thus there exists $\be'$ so $\be\be'=1$, i.e. $\be$ has an inverse.
\end{proof}
The lemma shows $B/\mq$ is a field. Hence $\mq$ is maximal.

Alternatively, this follows directly from ``lying-over" and ``going up" for integral extensions.\qedhere
\end{enumerate}
\end{proof}
\begin{thm}\llabel{ok-dedekind}
Suppose $K$ is a finite extension of $\Q$. Then unique factorization of ideals holds in $\sO_K$. 
\end{thm}
\begin{proof}
Combine Theorem~\ref{uf-dedekind} and Theorem~\ref{extension-dedekind}.
\end{proof}
\section{Primary decomposition*}
[ADD: Commutative algebra generalization, and a new proof of unique ideal factorization]
\section{Ideal class group}
Let $A$ be a Dedekind domain with fraction field $K$.
\begin{df}
A \textbf{fractional ideal} of $A$ is a nonzero $A$-submodule of $K$ such that $d\ma\in A$ for some $d\in A$.

A principal fractional ideal is one of the form
\[(b):=bA:=\{ba|a\in A\}.\]

The product of two fractional ideals is
\[\ma\mb=\bc{\sum a_ib_i|a_i\in \ma,b_i\in \mb}.\]
\end{df}
Note that given a nonzero $A$-submodule of $K$, it is finitely generated iff it is a fractional ideal. (Take common denominators of the generators.)

We can extend unique factorization to fractional ideals, in the same way that we can extend unique factorization from $\Z$ to $\Q$.
\begin{thm}
The set $\text{Id}(A)$ of fractional ideals is a free abelian group on the set of prime ideals. Thus each fraction ideal can be uniquely written in the form
\[
\ma=\prod_{\mfp} \mfp^{r_{\mfp}}.
\]
\end{thm}
\begin{proof}
Freeness follows from unique factorization (Theorem~\ref{uf-dedekind}) and existence of inverses follows from Corollary~\ref{uf-dedekind-cor}(3a).
\end{proof}

Now we are ready for the following definition.
\begin{df}
Let $P(A)$ be the group of principal ideals of $A$. 
The \textbf{ideal class group} $\Cl(A)$ is
$\text{Id}(A)/P(A)$. Its order is the \textbf{class number}.

The ideal class group and class number of $K$ are defined as the ideal class group and class number of $\sO_K$.
\end{df}
Note that we have an exact sequence
\[
0\to P(A)\to I(A)\to \Cl(A)\to 0.
\]

The class number is 1 iff all $A$ is a PID. Thus in some sense it measures how far $A$ is from being a PID.

Alternatively there is an exact sequence
\[
1\to \sO_K^{\times} \to K^{\times} \to I_K \to \Cl_K\to 1
\]
where the map $K^{\times} \to K$ is given by $a\mapsto (a)$.
%\fixme{Darn I can't seem to decide on notation.}
\begin{thm}[Approximation Theorem]
Let $x_1,\ldots, x_m\in A$, and $\mfp_1,\ldots, \mfp_m$ be distinct prime ideals. For any $x\in \N$, there is $x\in A$ such that 
\[\ord_{\mfp_i}(x-x_i)>n\]
for all $i$.
\end{thm}
\begin{proof}
Immediate from the Chinese Remainder Theorem.
\end{proof}
\section{Factorization in extensions}
\index{ramification index}
\index{residue class degree}
Assume AKLB, with $A$ Dedekind and $L/K$ finite separable. A prime ideal $\mfp\sub A$ will factor in $B$:
\[
\mfp B=\mathfrak P_1^{e_1}\cdots \mathfrak P_g^{e_g}.
\]
We say $e_i$ is the \textbf{ramification index} of $\mathfrak P_i$. 
For $\mathfrak P\mid \mfp$, we write $e(\mathfrak P/\mfp)$ for the ramification index and $f(\mathfrak P/\mfp)$ for the \textbf{residue class degree} $[B/\mathfrak P:A/\mfp]$.
\begin{enumerate}
\item If $e_k>1$ for some $k$, $\mfp$ is \textbf{ramified} in $B$.
\begin{enumerate}
\item
If $g=1$ and $e_1>1$, $\mfp$ is \textbf{totally ramified}.
\item When $|A/\mfp|=p^n$, $p$ prime, and $p\nmid [B/\mP:A/\mfp]$, then $\mfp$ is \textbf{tamely ramified}.
\end{enumerate}
\item If $e_i=f_i=1$ for all $i$, $\mfp$ \textbf{splits completely}.
\item If $\mfp B$ stays prime, $\mfp$ is \textbf{inert}.
\end{enumerate}
\begin{lem}\llabel{div-int}
A prime ideal $\mathfrak P$ divides $\mfp$ iff $\mathfrak P\cap K=\mfp$.
\end{lem}
\index{degree equation}
\begin{thm}[Degree equation]\llabel{deg-eq}
Let $m=[L:K]$ and suppose $\mfp B=\mathfrak P_1^{e_1}\cdots \mathfrak P_g^{e_g}$. Then
\[
\sum_{i=1}^g e_if_i=m.
\]
If $L/K$ is Galois, then all the $e_i$ are equal and all the $f_i$ are equal. Letting $e$ and $f$ denote these common values,
\[
efg=m.
\]
\end{thm}
\begin{proof}
We show both sides of the equation equal $\dim_{A/\mfp}(B/\mfp B)$.

For the LHS, by the Chinese Remainder Theorem $B/\mfp B\cong \prod_{i=1}^g B/\mathfrak P_i^{e_i}$ so
\begin{equation}\llabel{deg-eq-1}
\dim_{A/\mfp}(B/\mfp B)=\sum_{i=1}^g \dim_{A/\mfp}(B/\mathfrak P_i^{e_i}).
\end{equation}
Consider the filtration
\[
B\supset \mathfrak P_i\supset\cdots \supset \mathfrak P_i^{e_i}.
\]
There are no ideals between any two consecutive ideals by Corollary~\ref{uf-dedekind-cor} (the first iff), so there are no proper $B/\mathfrak P_i$-ideals (i.e. subspaces) of $\mP_i^r/\mP_i^{r+1}$. Hence $\dim_{B/\mathfrak P_i}(\mP_i^r/\mP_i^{r+1})=1$ and $\dim_{A/\mathfrak \mfp}(\mP_i^r/\mP_i^{r+1})=f_i$. Thus
\begin{equation}\llabel{deg-eq-2}
 \dim_{A/\mfp}(B/\mathfrak P_i^{e_i})=e_if_i.
\end{equation}
Combining~(\ref{deg-eq-1}) and~(\ref{deg-eq-2}) give
\[
\dim_{A/\mfp}(B/\mfp B)=\sum_{i=1}^g e_if_i.
\]

For the RHS, let $A'=(A-\mfp)^{-1}A=A_{\mfp}$ and $B'=(A-\mfp)^{-1}B$. First note that 
\[A/\mfp=\Frac(A/\mfp)\cong (A/\mfp)_{\mfp}=A'/\mfp A'\]
and 
\[B/\mfp\stackrel{(*)}{=}(A-\mfp)^{-1}(B/\mfp B)=B'/\mfp B',\]
where in (*) we use the fact that all elements of $A-\mfp$ are invertible modulo $\mfp B$, on account of $A/\mfp$ being a field. 
Note $A'$ is a a DVR and hence a PID. Since $B$ is finitely generated over $A$, and localization is exact, $B'$ is finitely generated over $A'$. Furthermore, $B'$ is $A'$-torsion free. The previous three statements along with the Structure Theorem for Modules gives that $B'\cong A'^n$ (as $A'$-modules) for some $n$. %Tensoring with $K$ gives $L\cong K^n$. Modding $B'\cong A'^n$ by $\mfp$ gives that $B'/\mfp B'=B/\mfp B$ has dimension $n$ over 
Perform the following operations:
\[
\xymatrix{
&B'\cong A'^n\ar^{\ot K}[ld]\ar^{\bullet/\mfp\bullet}[rd]&\\
K\cong L^n && B'/\mfp B'\cong (A'/\mfp A')^n\ar@{=}[d]\\
&& B/\mfp B\cong (A/\mfp)^n
}
\]
Hence
\[
[L:K]=n=\dim_{A/\mfp} B/\mfp B
\]
as needed.

Now suppose $L/K$ is Galois. Then $G(L/K)$ permutes the primes $\mP$ dividing $\mfp$. %For $\si\in G(L/K)$, $\si(B)=B$ so $\si(\mfp B)=\mfp B$ and
%\[
%\prod_{i=1}^g (\si\mP_i)^{e_i}=\prod_{i=1}^g \mP_i^{e_i}
%\]
%with corresponding exponents equal.
Since $e(\mP/\mfp)=e(\si\mP/\mfp)$ and $f(\mP/\mfp)=f(\si\mP/\mfp)$, it suffices to show $G(L/K)$ acts transitively.

Suppose by way of contradiction that $\mP$ and $\mQ$ are not in the same orbit. By the Chinese Remainder Theorem there exists $\be\in \mQ-\{\si \mP\mid \si\in G(L/K)\}$. Now
\[
\nm_{L/K}(\be)=\prod_{\si\in G(L/K)} \si(\be)\in \mQ\cap A=\mfp\subeq \mP,
\]
the first because $\be\in\mQ$ and the second because $\be\in B$ is integral over $A$ (which is integrally closed in $K$). But $\si(\be)\nin \mP$ so
\[
\prod_{\si\in G(L/K)} \si(\be)\nin \mP,
\]
a contradiction.
\end{proof}
Note that the ramification indices and residue degrees multiply under field extension.
\begin{pr}\llabel{ef-multiply}
Suppose that $M/L$ and $L/K$ are finite separable extensions (with Dedekind ring of integers), and that $\mQ\mid \mP\mid \mfp$ are primes in $M,L,K$ respectively. Then
\begin{align*}
e(\mQ/\mfp)&=e(\mQ/\mP)e(\mP/\mfp)\\
f(\mQ/\mfp)&=f(\mQ/\mP)f(\mP/\mfp)
\end{align*}
\end{pr}
\begin{proof}
The first comes from substituting the factorization of $\mP\sO_M$ in the factorization of $\mfp\sO_L$. The second comes from multiplicativity of degrees of field extensions.
\end{proof}
\section{Computing factorizations}
\begin{thm}[Criterion for ramification]\llabel{crit-ram}
Assume AKLB, with $L/K$ finite, $A$ Dedekind, and $B$ free over $A$. (The last condition is satisfied when $A$ is a PID.) Then $\mfp$ ramifies in $L$ iff $\mfp\mid \disc(B/A)$. In particular, only finitely many prime ideals ramify.
\end{thm}
\begin{proof}$\,$
\begin{enumerate}
\item
If $A$ is a ring, $B$ is a ring containing $A$ and admitting a finite basis $\{e_1,\ldots, e_m\}$ as an $A$-module, and $\ma$ is an ideal of $A$, then $\{\ol{e_1},\ldots, \ol{e_m}\}$ is a basis for $B/\ma B$ as a $A/\ma$ module, and $D(\ol{e_1},\ldots, \ol{e_m})= D(e_1,\ldots, e_m)\bmod{\ma}$. Hence
\[
\disc(B/A)\bmod \mfp=\disc((B/\mfp B)/(A/\mfp)).
\]
\item$\,$\vspace{-.9cm}
\begin{lem}
Let $k$ be a perfect field and $B$ be a $k$-algebra of finite dimension. Then $B$ is reduced (has no nilpotent elements) iff $\disc(B/k)\ne 0$.
\end{lem}
\begin{proof}
First suppose $\be\ne 0$ is a nilpotent element of $B$. Choose a basis $e_1=\be, e_2,\ldots, e_m$ of $B$. Then $\be e_i$ is nilpotent, so has trace 0. The first row of $(\tr(e_ie_j))$ is zero, so $\disc(B/k)=\det(\tr(e_ie_j))=0$.

Now suppose $B$ is reduced. By the Scheinnullstellensatz, $\cap_{\mfp \text{ prime}} \mfp =\text{nil}(R)=\{0\}$. Since $B/\mfp$ is integral and algebraic over $k$, Lemma~\ref{int-dom-field} shows it is a field. Hence $\mfp$ is maximal, and different $\mfp$ are relatively prime. Let $\mfp_1,\ldots, \mfp_r$ be prime ideals of $B$. By the Chinese Remainder Theorem, $B/\bigcap_{i=1}^r \mfp_i=\prod_{i=1}^r B/\mfp_i$ so
\[
\dim_k B\ge \dim_k\pa{B/\bigcap_{i=1}^r \mfp_i}= \sum_{i=1}^r \dim_k (B/\mfp_i)\ge r.
\]
Since $\dim_k B$ is assumed finite, $B$ has only finitely many prime ideals, say $\mfp_1,\ldots, \mfp_g$.

Each $B/\mfp_i$ is a {\it{finite separable}} (as $k$ is perfect) extension of $k$, so by Proposition~\ref{disc-and-fe}(2) (nondegeneracy of trace pairing), $\disc((B/\mfp_i)/k)\ne 0$. Since $B=B/\cap_{i=1}^g \mfp_i=\prod_{i=1}^g \mfp_i$, by taking the union of the bases for $B/\mfp_i$, we get $\disc(B/k)\ne 0$.
\end{proof}
\item 
Let $\mfp B=\prod_i \mP_i^{e_i}$. 
From the lemma, since $A/\mfp$ is perfect (as it is a finite field), \[\disc((B/\mfp B)/(A/\mfp))=0\] iff $B/\mfp B$ is not reduced. By the Chinese Remainder Theorem $B/\mfp B=\prod_i B/\mP_i^{e_i}$, and this is nonreduced iff some $e_i>1$, i.e. $\mfp$ ramifies.\qedhere
\end{enumerate}
\end{proof}
%[TODO: Add 3.39: Generalization of def'n of disc]
\begin{thm}[Computing the factorization of $\mfp B$]\llabel{compute-fact-pB}
Assume AKLB, $A$ is Dedekind and $L/K$ is separable. 
Suppose $B=A[\al]$ and $f(X)$ is the minimal polynomial of $\al$ over $K$. Let $\mfp$ be a prime ideal in $A$, and suppose $f(X)$ factorizes into irreducible polynomials modulo $\mfp$ as
\[
f(X)\equiv \prod_{i=1}^r g_i(X)^{e_i}\pmod{\mfp}.
\]
Then
\[
\mfp B=\prod_{i=1}^r (\mfp, g_i(\al))^{e_i}
\]
is the prime factorization of $\mfp B$. Moreover, letting $\bar{g}_i=g_i\bmod{\mfp}$,
\begin{align*}
B/(\mfp, g_i(\al))&\cong (A/\mfp)[X]/(\bar{g_i})\\
f_i&=\deg g_i.
\end{align*}
\end{thm}
\fixme{Generalize to when $\mfp$ relatively prime to conductor.}
\begin{proof}
The map $X\mapsto \al$ gives an isomorphism
\[
A[X]/(f(X))\cong B.
\]
Modding out by $\mfp$ gives
\[
k[X]/(\bar{f}(X))\cong B/\mfp.
\]
This gives a correspondence between ideals in $k[X]/(\bar{f}(X))$ and ideals in $B$ containing $\mfp$:
\begin{align*}
&\text{Maximal ideals of }k[X]/(\bar{f}(X))& (\bar{g}_i)\\
\longleftrightarrow \,&\text{Maximal ideals of }B/\mfp& (\bar{g}_i(\al))\\
\longleftrightarrow \,&\text{Maximal ideals of }B \text{ containing }\mfp& (\mfp, g_i(\al))
\end{align*}
%The maximal ideals $(\bar g_i)$ of $k[X]/(\bar{f}(X))$ correspond to the maximal ideals in $B/\mfp B$ which correspond to the maximal (i.e. prime since $B$ is Dedekind) ideals in $B$ containing $\mfp B$, i.e. the primes dividing $\mfp$.
But the maximal ideals of $B$ containing $\mfp$ are exactly the prime ideals (since $B$ is Dedekind) dividing $\mfp$ (Lemma~\ref{div-int}).

Now $\prod (\bar{g}_i)^{e_i}=0$ but no power with smaller exponents is 0. Hence $\mfp B\supeq \prod (\mfp,\bar{g}_i)^{e_i}$ but does not contain any power with smaller exponents, and equality holds.
\end{proof}
Note that the condition that $\mfp$ be relatively prime to the conductor is somewhat pesky. The problem is that the we may have prime ideals dividing $\mfp$ that are in the form $(\mfp, g(\al))$ where $g$ does has coefficients with elements of $\mfp$ in the denominator. So looking at the polynomial modulo $\mfp$ fails to capture this behavior. We can't look at them modulo a power of $\mfp$ either---because then we would not be in a field. The solution is to pass to the completion with respect to $\mfp$---we will do this in Chapter ??.
\begin{ex}[Quadratic extensions]\llabel{quad-ext-primes}$\,$
\begin{enumerate}
\item
\begin{tabular}{|c|c|c|}
\hline 
Prime $p$ & $x^{2}+1\bmod{p}$ & $(p)$\tabularnewline
\hline 
2 & $(x+1)^{2}$ & Ramifies: $(i+1)^{2}$\tabularnewline
\hline 
$p\equiv1\pmod4$ & factors since $\pf{-1}{p}=1$ & Splits\tabularnewline
\hline 
$p\equiv3\pmod4$ & irreducible since $\pf{-1}{p}=-1$ & Remains prime\tabularnewline
\hline
\end{tabular}
\item
\begin{tabular}{|c|c|c|}
\hline 
Prime $p$ & $x^{2}+2\bmod{p}$ & $(p)$\tabularnewline
\hline 
2 & $x^{2}$ & Ramifies: $(\sqrt{-2})^{2}$\tabularnewline
\hline 
$p\equiv1,3\pmod8$ & factors since $\pf{-2}{p}=1$ & Splits\tabularnewline
\hline 
$p\equiv5,7\pmod8$ & irreducible since $\pf{-2}{p}=-1$ & Remains prime\tabularnewline
\hline
\end{tabular}
\item
\begin{tabular}{|c|c|c|}
\hline 
Prime $p$ & $x^{2}+x+1\bmod{p}$ & $(p)$\tabularnewline
\hline 
3 & $(x-1)^2$ & Ramifies: $\pf{-3+\sqrt{-3}}{2}^2$\tabularnewline
\hline 
$p\equiv1\pmod3$ & factors since $\pf{-3}{p}=\pf{p}{3}=1$ & Splits\tabularnewline
\hline 
$p\equiv2\pmod3$ & irreducible since $\pf{-3}{p}=\pf{p}{3}=-1$ & Remains prime\tabularnewline
\hline
\end{tabular}
\end{enumerate}
Note we used quadratic reciprocity to translate the ``square" condition into a modular condition on $p$. This is true in general for any quadratic ring: whether a prime $p$ splits is entirely determined by a modular condition on $p$, because of quadratic reciprocity.
\end{ex}
\fixme{Mention some geometrical intuition.}
\section{Decomposition and inertia groups}
\llabel{sec:decomposition-and-inertia}
Let $L/K$ be a finite Galois extension, with residue fields $l$ and $k$. %Assume $k$ is perfect.

For a prime $\mfp$ of $K$, we know that there are three kinds of behavior it could express when we pass to $L$:
\begin{enumerate}
\item It can split into distinct primes $\mP_1,\ldots, \mP_g$.
\item The primes have some residue degree $f=[\sO_L/\mP_j:\sO_K/\mfp]$ over $\mfp$.
\item There can be ramification, the primes $\mP_j$ appearing with exponent $e$.
\end{enumerate}
Moreover, $[L:K]=efg$. We would like to separate these three kinds of behavior 
by defining two intermediate extensions $L^{D(\mP)}$ and $L^{I(\mP)}$.
\index{decomposition group}
\index{inertia group}
\begin{df}
Let $\mP\mid \mfp$ be primes in $L$ and $K$.

The \textbf{decomposition group} of $\mP$ is
\[
D_{L/K}(\mP)=\set{\si\in G(L/K)}{\si(\mP)=\mP}.
\]
The \textbf{inertia group} of $\mP$ is
\[
I_{L/K}(\mP)=\set{\si\in G(L/K)}{\si(\al)-\al\in \mP\text{ for all }\al\in \sO_L}.
\]
Equivalently, letting $l,k$ be the residue fields of $L$ and $K$, $I_{L/K}(\mP)$ is the kernel of the map $\ep:D(\mP)\to G(l/k)$.
\end{df}
We drop the subscript when there is no confusion. 
The main theorem is the following.
\begin{thm}\llabel{decomposition-and-inertia}
Let $L/K$ be a finite Galois extension with residue fields $l,k$, with $l/k$ separable.\footnote{If $l/k$ is not assumed separable, then $[L:L^{I(\mP)}]=e[l:k]_i$, $[L^{I(\mP)}:L^{D(\mP)}]=[l:k]_s$, and $[L^{D(\mP)}:L]=g$.} Let $\mP\mid \mfp$ be primes of $L$ and $K$. Let $e,f,g$ be the ramification index, residue class degree, and number of prime divisors of $\mfp$ in $L$.

Let $\mP_D=\mP\cap L^{D(\mP)}$ and $\mP_I=\mP\cap L^{I(\mP)}$ (the fixed fields of the decomposition and inertia groups). Then the following hold.
\begin{enumerate}
\item $[L:L^{I(\mP)}]=e$ and $\mP_I$ totally ramifies in $L/L^{I(\mP)}$.
\[
\mP_I\sO_L=\mP^e.
\]
\item $[L^{I(\mP)}:L^{D(\mP)}]=f$ and $\mP_D$ remains inert in the extension $L^{I(\mP)}/L^{D(\mP)}$.
\begin{align*}
\mP_D\sO_{L^{I(\mP)}}&=\mP_I\\
f(\mP_I/\mP_D)&=f.
\end{align*}
Moreover, $L^{I(\mP)}/K$ is Galois.
\item $[L^{D(\mP)}:K]=g$, and $\mfp$ splits completely in $L^{D(\mP)}$ if $L^{D(\mP)}/K$ is Galois\footnote{This is actually an iff. Exercise!}:
\[
\mfp\sO_{L^{D(\mP)}}=\mP_{1,D}\cdots \mP_{g,D}.
\]
\end{enumerate}
\end{thm}
We have the following picture. By Galois theory, the groups on the right are the Galois groups acting on each extension; we set $G=G(L/K)$.
\[
\xymatrixcolsep{5pc}\xymatrix{
\mP\ar@{-}[d]^{\text{total ramification}} &
L\ar@{-}[d]^{e}\ar@/^1pc/@{.}[d]^{I(\mP)}
\ar@/_2pc/@{.}[ddd]_{G}\\
\mP_I\ar@{-}[d]^{\text{inert}} &
L^{I(\mP)}\ar@{-}[d]^f\ar@/^1pc/@{.}[d]^{D(\mP)/I(\mP)}\\
\mP_D\ar@{-}[d]^{\text{totally split if Galois}}&
L^{D(\mP)}\ar@{-}[d]^g\ar@/^1pc/@{.}[d]^{G/D(\mP)\text{ if Galois}}\\
\mfp&K
}
\]
\begin{rem}
To study ramification, we can define subgroups of $I(\mP)$ called ramification groups and get fixed fields in between $L$ and $L^{I(\mP)}$. See Chapter~\ref{ramification}.
\end{rem}
The rest of this section is devoted to the proof of Theorem~\ref{decomposition-and-inertia}. We keep the notations and assumptions in the theorem.
\subsection{Decomposition group}
\begin{pr}
The decomposition group $D(\mP)$ has order $ef$, and for $\si\in G(L/K)$,
\[
D(\si(\mP))=\si D(\mP) \si^{-1}.
\]
Moreover, the following are equivalent:
\begin{enumerate}
\item $D(\mP)$ is normal in $G$.
\item The groups $D(\mQ)$ are equal for all $\mQ\mid \mfp$.
\item $L^{D(\mP)}/L$ is Galois.
\end{enumerate}
\end{pr}
\begin{proof}
 Since $D(\mP)$ is the stabilizer of $\mP$ under the action of $G:=G(L/K)$,  
$|G/D(\mP)|$ is simply the size of the orbit of $G$. This equals $g$ since $G$ acts transitively on the primes $\mP_1,\ldots, \mP_g$ above $\mfp$.
Hence
\[
|D(\mP)|=\frac{|G|}{|G/D(\mP)|}=\frac{n}{g}=ef.
\]

The second part follows from the fact that if $G$ acts on $S$ and $G$ is the stabilizer of $s\in S$, then $tGt^{-1}$ is the stabilizer of $ts$.

For the equivalences, use the second part and the fundamental theorem of Galois theory~\ref{ftogt}.
\end{proof}
We first show that $\mP_D$ is non-split in $L$ and prove item 3 of Theorem~\ref{decomposition-and-inertia}.

By the Fixed Field Theorem, $D(\mP)=G(L/L^{D(\mP)})$, and 
\begin{equation}\llabel{decomp-ef}
[L:L^{D(\mP)}]=|D(\mP)|=ef.\end{equation}
Since $L/L^{D(\mP)}$ is Galois, $D(\mP)$ acts transitively on the primes of $L$ above $\mP_D$. However, $D(\mP)$ stabilizes $\mP$; thus $\mP$ is the only prime above $\mP_D$.

By the degree equation, 
\[
ef=[L:L^{D(\mP)}]=e(\mP/\mP_D)f(\mP_D/\mfp).
\]
By Proposition~\ref{ef-multiply},
\begin{align*}
e&=e(\mP/\mP_D)e(\mP_D/\mfp)\\
f&=f(\mP/\mP_D)f(\mP_D/\mfp).
\end{align*}
All equations are satisfied only when $e=e(\mP/\mP_D)$, $f=f(\mP/\mP_D)$, and $e(\mP_D/\mfp)=f(\mP_D/\mfp)=1$.

If $L^{D(\mP)}$ is Galois, then $e(\mP_D/\mfp)=f(\mP_D/\mfp)=1$ are the same as the $e$ and $f$ values for all primes in $L^{D(\mP)}$ over $L$. Thus $\mfp$ is totally split over $L$.
\subsection{Inertia group}
First we study the homomorphism
\[
\ep: D(\mP)\to G(l/k).
\]
\begin{pr}
Suppose $\mP\mid \mfp$ are primes in $L$ and $K$, and 
let $k$ and $l$ be the residue fields of $L$ and $K$ with respect to $\mP$ and $\mfp$.
\begin{enumerate}
\item $l/k$ is normal (and hence Galois if separable).
\item Let $\ep$ be the map $D(\mP)\to G(l/k)$. Then $\ep$ is surjective.
\end{enumerate}
\end{pr}
\begin{proof}
Let $G=G(L/K)$.
\begin{enumerate}
\item We need to show that for $\ol{\al}\in l$, its minimal polynomial over $k$ splits completely. Let $\al$ be a lift to $\sO_L$ and let 
\[f(X)=\prod_{\si\in G} (X-\si(\al))\in \sO_K[X].\]
Taking this modulo $\mP$ gives a polynomial in $k[X]$ containing $\ol{\al}$ as a root and splitting completely.

Thus $l/k$ is normal, and hence Galois if it is separable.
\item First note we may assume $l/k$ is separable. Indeed, we have $G(l/k)\cong G(l^{\text{sep}}/k)$\footnote{From the Fixed Field Theorem $l/l^{G(l/l^{\text{sep}})}$ is Galois. 
But $l/l^{\text{sep}}$ is purely inseparable and normal.  
Thus we must have $l=l^{G(l/l^{\text{sep}})}$, i.e. every automorphism of $l/k$ is trivial on $l/l^{\text{sep}}$.}.

It suffices to show that $\ep(D(\mP))$ acts transitively on the conjugates of $\ol{\al}$ over $k$ (as then the image has at least $[l:k]=|G(l/k)|$ elements).
By the Chinese Remainder Theorem, choose $\al\in \sO_L$ such that 
\[
\al\equiv \begin{cases}
\ol{\al}\pmod{\mP}\\
0\pmod{\mP'},&\mP'\ne \mP, \mP'\mid \mfp.
\end{cases}
\]
%Let
%\[
%f(X):=\prod_{\si\in G} (X-\si(\al))\in \sO_K[x].
%\]
Define $f$ as in item 1. Then, noting that for $\si\in G\bs D(\mP)$, we have $\al\equiv 0\pmod{\si^{-1}(\mP)}$ and hence $\si(\al)\equiv 0\pmod{\mP}$, 
\begin{align*}
\ol{f}(X)&=\prod_{\si\in D(\mP)}(X-\ol{\si(\al)})\prod_{\si\nin D(\mP)} x\\
&=\underbrace{\prod_{\si\in D(\mP)} (X-\ep(\si)(\ol{\al}))}_{(*)}\prod_{\si\nin D(\mP)} x\in k[x]
\end{align*}
%The minimal polynomial $\ol{g}$ of $\al$ over $k$ divides $\ol{f}$. 
%Taking this modulo $\mP$, and using part 1 (*)
%has $\ol{\al}$ as a root. %(By definition of $\ep$, $\si(\al)=\ep(\si)(\ol{\al})$.) 
Now $(*)$ is in $k[x]$, so is divisible by the minimal polynomial of $\al$ over $k$. Given a conjugate $\ol{\al'}$ of $\ol{\al}$, it divides $(*)$, so equals $(\ep(\si))(\ol{\al})$ for some $\si$.\qedhere
%The minimal polynomial of $\ol{\al}$ as root. 
\end{enumerate}
\end{proof}
\begin{cor}\llabel{ses-inertia-decomp}
There is a short exact sequence
\[
1\to I(\mP)\to D(\mP)\to G(l/k)\to 1,
\]
i.e. $D(\mP)/I(\mP)\cong G(l/k)$.
\end{cor}
Note $I(\mP)$ is normal in $D(\mP)$ as it is a kernel, so $L^{I(\mP)}/K$ is Galois. 

Now we finish the proof of Theorem~\ref{decomposition-and-inertia}. The above corollary gives 
\[
|D(\mP)/I(\mP)|=|G(l/k)|=[l:k]=f.
\]
Since $G(L^{I(\mP)}/L^{D(\mP)})=|D(\mP)/I(\mP)|=f$, we get $[L^{I(\mP)}:L^{D(\mP)}]=f$. From~(\ref{decomp-ef}) we get $[L:L^{I(\mP)}]=e$.

We will apply Corollary~\ref{ses-inertia-decomp} to $L/L^{I(\mP)}$. Note
\[
D_{L/L^{I(\mP)}}(\mP)=I_{L/L^{I(\mP)}}(\mP)=G(L/L^{I(\mP)})=I(\mP)
\]
since the fact that $I(\mP)$ operates trivially on $l/k$ implies that it operates trivially on $l/\kappa(\mP_I)$. Hence the corollary gives
\[
G(l/\kappa(\mP_I))=1,
\]
i.e. $l=\kappa(\mP_I)$ and $f(\mP/\mP_I)=1$. We know that $\mP_D$ is non-split in $L$, so 
\begin{align*}
e=[L:L^{I(\mP)}]&=e(\mP/\mP_I)\underbrace{f(\mP/\mP_I)}_{=1}\\
f=[L^{I(\mP)}:L^{D(\mP)}]&=e(\mP_I/\mP_D)f(\mP_I/\mP_D).
\end{align*}
Now
\begin{align*}
e&=e(\mP/\mP_D)=e(\mP/\mP_I)e(\mP_I/\mP_D)\\
f&=f(\mP/\mP_D)=f(\mP/\mP_I)f(\mP_I/\mP_D),
\end{align*}
so we must have
\begin{align*}
e(\mP/\mP_I)&=e,&f(\mP/\mP_I)&=1\\
e(\mP_I/\mfp)&=1,&f(\mP_I/\mfp)&=f.
\end{align*}
This finishes the proof.
\subsection{Further properties and applications}
\begin{thm}
Let $M/K$ be a Galois extension and $L/K$ a subextension. Then
\begin{enumerate}
\item 
\begin{align*}
D_{M/L}(\mP)&=D_{M/K}(\mP)\cap G(M/L)\\
I_{M/L}(\mP)&=I_{M/K}(\mP)\cap G(M/L).
\end{align*}
\item
If $L/K$ is Galois, the following commutes and has exact rows and columns.
\[
\xymatrix{
& 1\ar[d] & 1\ar[d] & 1\ar[d] & \\
1\ar[r] &I_{M/L}\ar[r]\ar[d]& I_{M/K} \ar[r]\ar[d] & I_{L/K} \ar[r]\ar[d] &1\\
1\ar[r] &D_{M/L}\ar[r]\ar[d]& D_{M/K} \ar[r]\ar[d] &D_{L/K} \ar[r]\ar[d] &1\\
1\ar[r] &G(M/L)\ar[r]\ar[d]& G(M/K) \ar[r]\ar[d] & G(L/K) \ar[r]\ar[d] &1\\
& 1 & 1 & 1 &
}
\]
\end{enumerate}
\end{thm}
\begin{thm}\llabel{unram-in-compositum}
Let $L/K$ and $L'/K$ be finite extensions. %number fields. 
Then $\mfp$ unramified in $L,L'$ if and only if $\mfp$ is unramified in $LL'$.
\end{thm}
\fixme{Make notation consistent}
\begin{proof}
First we prove the result for $L,L'$ Galois. Note that for any Galois extension $M/K$, with $\mP\mid \mfp$ primes in $M$ and $K$,
\begin{equation}\llabel{inertia-1-iff-unramified}
I_{\mP}=1\iff \mfp\text{ unramified in }M.
\end{equation}
Now there is a injective homomorphism
\begin{gather*}
\Phi:G(LL'/K)\hra G(L/K)\times G(L'/K)\\
\Phi(\si)=(\si|_L,\si|_{L'}).
\end{gather*}
%[reference]
%(It is injective since the action of $\si$ on $L$ and on $L'$ determines its action on $LL'$.) 
Take $\mQ\mid \mfp$ with $\mQ$ a prime in $LL'$, and let $\mP=\mQ\cap \sO_L$ and $\mP'=\mQ\cap \sO_{L'}$. Suppose $\si\in I_{\mQ}$. Then $\si(\mQ)=\mQ$ and hence, taking the intersections with $\sO_L,\sO_{L'}$ (which are fixed by $\si$ since $L,L'$ are Galois)
\begin{align*}
\si|_{L}(\mP)&=\mP\\
\si|_{L'}(\mP')&=\mP'.
\end{align*}
This shows $\si|_{L}\in I_{\mP},\si|_{L'}\in I_{\mP'}$; by assumption and~(\ref{inertia-1-iff-unramified}), we get $(\si|_L,\si|_{L'})=(1,1)$. By injectivity of $\Phi$, $\si=1$. This shows $I_{\mQ}=1$, by~(\ref{inertia-1-iff-unramified}) again, we get $\mQ$ is unramified over $\mfp$, as needed.

Now consider the general case. Given $\mP\mid \mfp$ in $L$ and $K$, let $\mQ$ be a prime above $\mP$ in the Galois closure $L^{\text{gal}}$. Now $(L^{\text{gal}})^{I_{\mQ}(L^{\text{gal}}/L)}$ is a Galois extension containing $L$; since $L^{\text{gal}}$ is the Galois closure of $L$, we get
\[
L^{\text{gal}}=(L^{\text{gal}})^{I_{\mQ}(L^{\text{gal}}/L)},
\]
But $[L^{\text{gal}}:(L^{\text{gal}})^{I_{\mQ}(L^{\text{gal}}/L)}]$ is the ramification degree of $\mQ/\mP$; we see that it is 1, i.e. $\mQ$ is not ramified over $\mP$ and hence not ramified over $\mfp$. Thus $L^{\text{gal}}/K$ is unramified. Similarly, $L'^{\text{gal}}/K$ is unramified. By the above, $L^{\text{gal}}L'^{\text{gal}}/K$ is unramified, so $LL'/K$ is unramified.
\end{proof}
%\begin{pr}
%\begin{enumerate}
%\item
%$|I(\mP)|=e$ and $|D(\mP)/I(\mP)|=f$. 
%\item
%We have
%\begin{align*}
%e_{\mP/\mP_I}&=e,&f_{\mP/\mP_I}&=1\\
%e_{\mP_I/\mfp}&=1,&f_{\mP_I/\mfp}&=f.
%\end{align*}
%\end{enumerate}
%\end{pr}
%\begin{proof}
%\begin{enumerate}
%\item
%\item Use the multiplicative property of $e$ and $f$ (reference).
%\end{enumerate}
%\end{proof}
%\section{Eisenstein extensions}
%Moved to ch. 6
%\section{Modules over Dedekind Domains*}
%To be included.
\section{Problems}
\llabel{sec:factorization-problems}
\begin{enumerate}
\item 
A \textbf{half-factorial domain} (HFD) $A$ is an integral domain where any given factorization of $a$ has the same length. Prove Carlitz's Theorem:
\begin{thm}[Carlitz]
The ring of integers $\sO_K$ is a HFD iff the class group has order at most 2.
\end{thm}
See AMM, 12/2011, for related results.
\item
Show that if $\mfp$ splits completely in $L^{D(\mP)}$, then $L^{D(\mP)}/L$ is Galois.

Conclude that if $\mfp$ splits completely in $L$, then $\mfp$ splits completely in the Galois closure $L\gal$.
%silly problem
%\item
%Show that any Dedekind domain is \textbf{atomic}: any nonzero element can be written as a product of irreducible element. (Warning: we're working with elements, not ideals.)
\end{enumerate}
%\begin{enumerate}
%\item
%Prove the following:
%Let $K$ be a finite extension of $\Z$, and suppose $\al$ is integral with $\Q(\al)=K$. Suppose $p$ is relatively prime to $\frac{\disc(\Z[\al]/\Z)}{\disc(\sO_K/\Z)}$. Let $f(X)$ be the minimal polynomial of $\al$ over $\Q$. Let $p$ be a prime and suppose $f(X)$ factorizes into irreducible polynomials modulo $p$ as
%\[
%f(X)\equiv \prod_{i=1}^r g_i(X)^{e_i}\pmod{p}.
%\]
%Then
%\[
%\mfp B=\prod_{i=1}^r (\mfp, g_i(\al))^{e_i}
%\]
%is the prime factorization of $\mfp B$. (Hint: Localize at $p$. Cf. Theorem~\ref{compute-fact-pB})
%\end{enumerate}